@{
    ViewBag.Title = "Editar Marca";
}

<style>
    .slick_demo_2 .ibox-content {
        margin: 0 5px;
        padding: 5px;
    }

    .box-imagem {
        box-shadow: 0px 0px 5px #999;
        xxborder: 1px solid #EAEAEA;
        padding: 2px;
        width: 100px;
        height: 100px;
    }

        .box-imagem img {
            width: 96px;
            height: 96px;
        }

</style>

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Editar marca</h2>
        <ol class="breadcrumb">
            <li>
                <a href="/Home">Home</a>
            </li>
            <li>
                <a href="/Marca/">Marcas</a>
            </li>
            <li class="active">
                <strong>Editar</strong>
            </li>
        </ol>
    </div>
    <div class="col-lg-2">

    </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight">

    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Dados da marca</h5>
                </div>
                <div class="ibox-content">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="col-lg-2 control-label">Empresa</label>
                            <div class="col-lg-10">
                                <select id="cmbEmpresa" placeholder="Selecione a empresa" class="chosen-select" name="setor" tabindex="2">></select>

                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-lg-2 control-label">Nome</label>
                            <div class="col-lg-10">
                                <input type="text" id="txtNome" placeholder="Nome da marca" class="form-control">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-lg-2 control-label">CNPJ</label>
                            <div id="listaCnpj" class="col-lg-9">
                                <input id="txtcnpj" type="text" placeholder="CNPJ da marca" class="form-control txtcnpj" data-mask="99.999.999/9999-99">
                            </div>
                            <div class="col-lg-1">
                                <button id="btnInserircnpj" onclick="addCnpj()" class="btn btn-sm btn-white" type="button">+</button>
                            </div>

                        </div>

                        <div id="cnpjLista"></div>

                        <div class="form-group">
                            <label class="col-lg-2 control-label">Descrição</label>
                            <div class="col-lg-10">
                                <textarea id="txtDescricao" class="form-control" style="resize:none;" rows="5" placeholder="Descrição da marca"></textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-lg-2 control-label">Site</label>
                            <div class="col-lg-10">
                                <div class="input-group m-b">
                                    <span class="input-group-addon">http://</span> <input id="txtSite" type="text" placeholder="Site da marca" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-lg-2 control-label">Facebook</label>
                            <div class="col-lg-10">
                                <div class="input-group m-b">
                                    <span class="input-group-addon">http://</span> <input id="txtRS0" type="text" placeholder="Facebook da marca" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-lg-2 control-label">Instagram</label>
                            <div class="col-lg-10">
                                <div class="input-group m-b">
                                    <span class="input-group-addon">http://</span> <input id="txtRS1" type="text" placeholder="Instagram da marca" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-lg-2 control-label">Twitter</label>
                            <div class="col-lg-10">
                                <div class="input-group m-b">
                                    <span class="input-group-addon">http://</span> <input id="txtRS2" type="text" placeholder="Twitter da marca" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-lg-2 control-label">Youtube</label>
                            <div class="col-lg-10">
                                <div class="input-group m-b">
                                    <span class="input-group-addon">http://</span> <input id="txtRS3" type="text" placeholder="Youtube da marca" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-lg-2 control-label">Klout</label>
                            <div class="col-lg-10">
                                <div class="input-group m-b">
                                    <span class="input-group-addon">http://</span> <input id="txtRS4" type="text" placeholder="Klout da marca" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-lg-2 control-label">Logo da marca</label>

                            <div class="col-lg-2" id="divimage">
                            

                            </div>

                            <div class="col-lg-8">
                                <div class="fileinput fileinput-new input-group" data-provides="fileinput">
                                    <div class="form-control" data-trigger="fileinput">
                                        <i class="glyphicon glyphicon-file fileinput-exists"></i>
                                        <span class="fileinput-filename"></span>
                                    </div>
                                    <span class="input-group-addon btn btn-default btn-file">
                                        <span class="fileinput-new">Selecionar</span>
                                        <span class="fileinput-exists">Alterar</span>
                                        <input type="file" id="imagemMarca" name="imagemMarca" />
                                    </span>
                                    <a href="#" class="input-group-addon btn btn-default fileinput-exists" data-dismiss="fileinput">Remover</a>
                                </div>
                                <span class="help-block m-b-none">Selecione uma imagem nas dimensões 96 x 96</span>
                            </div>
                        </div>

                    </form>

                    <div class="row">
                        <div class="col-lg-8 col-lg-offset-2">
                            <br />
                            <button class="btn btn-primary" type="submit" onclick="SalvarMarca()">Salvar</button>

                        </div>
                        <div class="col-lg-2">
                            <br />
                            <button class="btn btn-white" onclick="cancelar()" type="submit">Cancelar</button>

                        </div>

                    </div>

                </div>



            </div>
        </div>

    </div>


</div>

@section styles {
    <link href="~/Content/plugins/jasny/jasny-bootstrap.min.css" rel="stylesheet" />
    <link href="~/Content/plugins/chosen/bootstrap-chosen-bootstrap-chosen.css" rel="stylesheet" />
    <link href="~/Content/SweetAlert/sweetalert.css" rel="stylesheet" />
    <style type="text/css"></style>
}

@section scripts {

    @Scripts.Render("~/plugins/sweetAlert")
    @Scripts.Render("~/plugins/chosen")
    @Scripts.Render("~/plugins/jasnyBootstrap")
    <script src="~/Scripts/validacoes.js"></script>
    <script src="~/Scripts/plugins/typeahead/bootstrap3-typeahead.js"></script>

    <script>

        function ExisteCNPJBanco(valcnpj, txtcnpj) {
            var uri = "/api/MarcaAPI/GetVerificaCnpjExistente";
            uri = uri + "?cnpjmarca=" + valcnpj;

            var cnpjCadastrado = false;

            $.ajax({
                url: uri,
                async: false,
                success: function (data) {
                    if (data == true) {
                        $(txtcnpj).addClass("cnpj-existente").removeClass("cnpj-valido").removeClass("cnpj-invalido");
                        cnpjCadastrado = true;
                    }
                    else {
                        $(txtcnpj).addClass("cnpj-valido").removeClass("cnpj-invalido").removeClass("cnpj-existente");
                        cnpjCadastrado = false;
                    }
                }
            });

            return cnpjCadastrado;
        }

        function CNPJdessaMarca(valcnpj, idmarca){

            var uri = "/api/MarcaAPI/GetExisteCNPJBancoEditar";
            uri = uri + "?cnpjmarca=" + valcnpj + "&idmarca=" + idmarca;

            var cnpjCadastrado = false;

            $.ajax({
                url: uri,
                async: false,
                success: function (data) {
                    if (data == true) {
                        cnpjCadastrado = true;
                    }
                    else {
                        cnpjCadastrado = false;
                    }
                }
            });

            return cnpjCadastrado;

        }

        function SetaEventoChange() {


            $(".txtcnpj").unbind("change");

            $(".txtcnpj").change(function () {

                var valcnpj = $(this).val();
                var valcmponto = valcnpj;

                //Limpa caractes especiais do CNPJ
                valcnpj = valcnpj.replace(/[^0-9]+/g, '');

                if (valcmponto == "") {
                    $(this).removeClass("cnpj-invalido").removeClass("cnpj-existente").removeClass("cnpj-valido");
                }
                else if(validarCNPJ(valcnpj) == false) {
                    $(this).addClass("cnpj-invalido").removeClass("cnpj-valido").removeClass("cnpj-existente");
                }
                else if(CNPJdessaMarca(valcmponto, @ViewBag.idMarca)){
                    $(this).removeClass("cnpj-invalido").removeClass("cnpj-existente");
                }
                else {
                    ExisteCNPJBanco(valcmponto, this);
                    addCnpj();
                }


            });

        }

        $(document).ready(function () {

            $('#cmbEmpresa').on('change', function () {

                if (cmbEmpresa.value != "0") {
                    $('.chosen-single').removeClass("combo-invalido");
                }
            });

            $('#txtDescricao').focusout(function () {

                if (txtDescricao.value != "") {
                    $('#txtDescricao').removeClass("campo-invalido");
                }

            });

            $('#txtSite').focusout(function () {

                if (txtSite.value != "") {
                    $('#txtSite').removeClass("campo-invalido");
                }

            });

            $('#txtNome').focusout(function () {

                if (txtNome.value != "") {
                    $('#txtNome').removeClass("campo-invalido");
                }

            });

            var config = {
                '.chosen-select':{ width: "100%" },
                '.chosen-select-deselect': { allow_single_deselect: true },
                '.chosen-select-no-single': { disable_search_threshold: 10 },
                '.chosen-select-no-results': { no_results_text: 'Oops, nothing found!' },
                '.chosen-select-width': {}
            }
            for (var selector in config) {
                $(selector).chosen(config[selector]);
            }

            CarregarMarca(@ViewBag.idMarca);
        });

        function CarregarMarca(idMarca) {

            var uri = "/api/MarcaAPI/Get/" + idMarca;

            $.getJSON(uri)
                .done(function (data) {
                    var marca = data.Marca;
                    var idempmarca = data.Marca.idEmpresa;

                    $.each(data.Empresas, function (key, item) {
                        if (item.idempresa === idempmarca) {
                            $("#cmbEmpresa").append("<option value=" + item.idempresa+ " selected>" + item.nome + "</option>");
                            $("#cmbEmpresa").trigger('chosen:updated');
                        }
                        else {
                            $("#cmbEmpresa").append("<option value=" + item.idempresa + ">" + item.nome + "</option>");
                            $("#cmbEmpresa").trigger('chosen:updated');
                        }
                    });

                    $("#txtNome").val(marca.Nome);
                    $("#txtDescricao").val(marca.Descricao);
                    $("#txtSite").val(marca.UrlSite);

                    $.each(data.Marca.cnpjs, function (key, item) {
                        if(key == 0){
                            //alert(item.cnpj);
                            $("#txtcnpj").val(item.cnpj);
                            $("#txtcnpj").attr("data-idcnpj",item.idcnpjmarca);
                        }else{
                            $("#cnpjLista").append("<div id='elemento' class='form-group'><div class='col-lg-9 col-md-offset-2'><input type='text'placeholder='CNPJ da empresa' class='form-control txtcnpj' data-mask='99.999.999/9999-99' data-idcnpj='"+ item.idcnpjmarca +"' value='"+ item.cnpj +"'></div><div class='col-lg-1'><button class='btn btn-sm btn-white' type='button' onclick='removeCNPJ(this)' >-</button></div></div>");
                        }

                    });

                    $.each(data.Marca.RedesSociais, function (key, item) {
                        var idRedeTxt = item.idRedeSocial-1;
                        $("#txtRS" + idRedeTxt).val(item.urlRedeSocial);
                    });

                    $('<div>', { html: carregaImage(marca.caminhoImagem) }).appendTo($('#divimage'));

                    SetaEventoChange();

                });
        }


        function carregaImage(caminhoImagem){
            return "<div class='box-imagem'><a><img alt='image' src='"+caminhoImagem+"'></a></div>"
        }


        var cnpjsExcluir = [];

        var count = 0;
        function addCnpj() {

            var cont2 = 0;

            $(".txtcnpj").each(function () {
                if ($(this).val() == "" || $(this).val() == null) {
                    cont2++;

                }
            });

            if (cont2 == 0) {
                count++;
                //    alert(count);
            $("#cnpjLista").append("<div id='elemento' class='form-group'><div class='col-lg-9 col-md-offset-2'><input type='text'placeholder='CNPJ da marca' class='form-control txtcnpj' data-mask='99.999.999/9999-99'></div><div class='col-lg-1'><button class='btn btn-sm btn-white' type='button' onclick='removeCNPJ(this)' >-</button></div></div>");

            SetaEventoChange();
            }

        }

        function removeCNPJ(btn) {

            var txtCNPJ = $(btn).parent().parent().find("input")[0];

            var cnpj = {"idcnpjmarca": $(txtCNPJ).attr("data-idcnpj"), "excluir":"true"};
            cnpjsExcluir.push(cnpj);
            $(btn).parent().parent().remove();
        }
        //endcnpjs

        function VerificaForm() {

            var EmpresaValidacao = true;
            var nomeValidacao = true;
            var CnpjValidacao = true;
            var descricaoValidacao = true;
            var urlsiteValidacao = true;

            //validar nome
            if (cmbEmpresa.value == 0) {
                $('.chosen-single').addClass("combo-invalido");
                EmpresaValidacao = false;
            }

            if (txtSite.value == "") {
                $(txtSite).addClass("campo-invalido");
                urlsiteValidacao = false;
            }

            if (txtDescricao.value == "") {
                $(txtDescricao).addClass("campo-invalido");
                descricaoValidacao = false;
            }

            if (txtNome.value == "") {
                $(txtNome).addClass("campo-invalido");
                nomeValidacao = false;
            }

            //valida os CNPJs

            $(".txtcnpj").each(function (i , e) {


                var valcnpj = $(e).val();
                var valcmponto = valcnpj;

                //Limpa caractes especiais do CNPJ
                valcnpj = valcnpj.replace(/[^0-9]+/g, '');

                if (valcnpj != "") {
                    if (!validarCNPJ(valcnpj)) {
                        $(e).addClass("cnpj-invalido").removeClass("cnpj-valido").removeClass("cnpj-existente");
                        CnpjValidacao = false;
                    }
                    else if(CNPJdessaMarca(valcmponto, @ViewBag.idMarca)){
                        CnpjValidacao = true;
                    }
                    else if(ExisteCNPJBanco(valcmponto, e)){
                        CnpjValidacao = false;
                    }
                }


            });


            return EmpresaValidacao && nomeValidacao && CnpjValidacao && descricaoValidacao && urlsiteValidacao;
        }


        function SalvarMarca() {

            if (VerificaForm()) {

                //var listaCnpjs = new Array();

                ////for (var x = 0; x <= count; x++) {
                ////    var c = { "idcnpjmarca": $("#txtcnpj" + x).attr("data-idcnpj"), "cnpj": $("#txtcnpj" + x).val() };
                ////    listaCnpjs.push(c);
                ////}

                //$(".txtcnpj").each(function() {
                //    var c = { "idcnpjmarca": $(this).attr("data-idcnpj"), "cnpj": $(this).val() };

                //    //alert("achou cnpj : "+$(".txtcnpj").attr("data-idcnpj")+" ------ "+$(".txtcnpj").val());

                //    listaCnpjs.push(c);
                //});

                var listaCnpjs = new Array();

                $(".txtcnpj").each(function() {
                    if($(this).val() != "" && $(this).val() != null){
                        var c = { "idcnpjmarca": $(this).attr("data-idcnpj"), "cnpj": $(this).val() };                   
                        listaCnpjs.push(c);
                    }
                });


                var listaDeRedesSociais = new Array();

                if ($("#txtRS0").val() != null) {

                    var r = { "idredesocial": "1", "urlredesocial": $("#txtRS0").val() }

                    listaDeRedesSociais.push(r);
                }

                if ($("#txtRS1").val() != null) {

                    var r = { "idredesocial": "3", "urlredesocial": $("#txtRS1").val() }

                    listaDeRedesSociais.push(r);
                }

                if ($("#txtRS2").val() != null) {

                    var r = { "idredesocial": "2", "urlredesocial": $("#txtRS2").val() }

                    listaDeRedesSociais.push(r);
                }

                if ($("#txtRS3").val() != null) {

                    var r = { "idredesocial": "4", "urlredesocial": $("#txtRS3").val() }

                    listaDeRedesSociais.push(r);
                }
                if ($("#txtRS4").val() != null) {

                    var r = { "idredesocial": "5", "urlredesocial": $("#txtRS4").val() }

                    listaDeRedesSociais.push(r);
                }

                listaCnpjs = listaCnpjs.concat(cnpjsExcluir);

                var marca = {
                    idMarca: @ViewBag.idMarca,
                    nome: $("#txtNome").val(),
                    descricao: $("#txtDescricao").val(),
                    urlsite: $("#txtSite").val(),
                    idEmpresa: $("#cmbEmpresa").val(),
                    redessociais: listaDeRedesSociais,
                    cnpjs: listaCnpjs
                }

                var dataMarca = new FormData();
                var files = $("#imagemMarca").get(0).files;

                if(files.length > 0){
                    dataMarca.append("imagemMarca", files[0]);
                }

                dataMarca.append("marca", JSON.stringify(marca));

                $.ajax({
                    type: "PUT",
                    //dataType: "json",
                    url: "/api/MarcaAPI/Put/"+@ViewBag.idMarca,
                    contentType: false,
                    processData: false,
                    data: dataMarca,
                    success: function (data) {
                    },
                    error: function (error) {
                        jsonValue = jQuery.parseJSON(error.responseText);
                        //jError('An error has occurred while saving the new part source: ' + jsonValue, { TimeShown: 3000 });
                    }
                });
                //location.reload();
                window.location = "/Marca/";
            }
            else{
                ChamaSwal();
            }
        }

        function ChamaSwal() {

            swal({
                title: "Não foi possível editar a marca.",
                text: "Campos obrigatórios não preenchidos adequadamente.",
                showConfirmButton: true,
                confirmButtonText: "Ok"
            },
            function (isConfirm) {
                if (isConfirm) {
                    $('html, body').animate({ scrollTop: 0 }, 'slow');
                }
            });
        }

        function cancelar() {
            window.location = "/Marca/";
        }


    </script>

}